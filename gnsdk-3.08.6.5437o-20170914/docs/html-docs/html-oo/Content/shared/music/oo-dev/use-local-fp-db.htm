<!DOCTYPE html>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" lang="en-us" xml:lang="en-us" class="_Skins_HTML5___Top_Navigation" data-mc-search-type="Stem" data-mc-help-system-file-name="index.xml" data-mc-path-to-help-system="../../../../" data-mc-has-content-body="True" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic;Default" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-medium="non-print" data-mc-toc-path="[%=System.LinkedTitle%]">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><title>Using a Local Fingerprint Database</title>
        <link href="../../../../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" />
        <link href="../../../../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" />
        <link href="../../../../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Tablet.css" rel="stylesheet" />
        <link href="../../../../Skins/Default/Stylesheets/Components/Mobile.css" rel="stylesheet" />
        <link href="../../../../Skins/Fluid/Stylesheets/foundation.6.2.3.css" rel="stylesheet" />
        <link href="../../../../Skins/Fluid/Stylesheets/Styles.css" rel="stylesheet" />
        <link href="../../../../Skins/Fluid/Stylesheets/Tablet.css" rel="stylesheet" />
        <link href="../../../../Skins/Fluid/Stylesheets/Mobile.css" rel="stylesheet" />
        <link href="https://cloud.typography.com/7045754/7789972/css/fonts.css" rel="stylesheet" />
        <style>/*&lt;meta /&gt;*/

.button.next-topic-button
{
	-pie-background: url('../../../../Skins/Default/Stylesheets/Images/navigate-next.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.previous-topic-button
{
	-pie-background: url('../../../../Skins/Default/Stylesheets/Images/navigate-previous.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.separator-button
{
	-pie-background: linear-gradient(#ffffff, #ececec);
}

.button.remove-highlight-button
{
	-pie-background: url('../../../../Skins/Default/Stylesheets/Images/highlight.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.separator-button
{
	-pie-background: linear-gradient(#ffffff, #ececec);
}

.button.expand-all-button
{
	-pie-background: url('../../../../Skins/Default/Stylesheets/Images/expand.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.separator-button
{
	-pie-background: linear-gradient(#ffffff, #ececec);
}

.button.print-button
{
	-pie-background: url('../../../../Skins/Default/Stylesheets/Images/printer.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.collapse-all-button
{
	-pie-background: url('../../../../Skins/Default/Stylesheets/Images/collapse.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.needs-pie
{
	behavior: url('../../../../Resources/Scripts/PIE-no-motw.htc');
}

</style>
        <link href="../../../Resources/Stylesheets/MainStyles.css" rel="stylesheet" />
        <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js">
        </script>
        <script src="../../../../Resources/Scripts/custom.modernizr.js">
        </script>
        <script src="../../../../Resources/Scripts/jquery.min.js">
        </script>
        <script src="../../../../Resources/Scripts/require.min.js">
        </script>
        <script src="../../../../Resources/Scripts/require.config.js">
        </script>
        <script src="../../../../Resources/Scripts/foundation.6.2.3_custom.js">
        </script>
        <script src="../../../../Resources/Scripts/plugins.min.js">
        </script>
        <script src="../../../../Resources/Scripts/MadCapAll.js">
        </script>
    </head>
    <body>
        <div class="foundation-wrap off-canvas-wrapper">
            <div class="off-canvas-wrapper-inner" data-off-canvas-wrapper="">
                <aside class="off-canvas position-right" id="offCanvas" data-off-canvas="" data-position="right" data-mc-ignore="true">
                    <ul class="off-canvas-drilldown vertical menu off-canvas-list" data-drilldown="" data-mc-back-link="Back" data-mc-css-tree-node-expanded="is-drilldown-submenu-parent" data-mc-css-tree-node-collapsed="is-drilldown-submenu-parent" data-mc-css-sub-menu="vertical menu slide-in-right is-drilldown-submenu" data-mc-include-indicator="False" data-mc-include-icon="False" data-mc-include-parent-link="True" data-mc-include-back="True" data-mc-defer-expand-event="True" data-mc-expand-event="click.zf.drilldown" data-mc-toc="True">
                    </ul>
                </aside>
                <div class="off-canvas-content inner-wrap" data-off-canvas-content="">
                    <div>
                        <nav class="title-bar tab-bar" data-mc-ignore="true">
                            <div class="middle title-bar-section outer-row clearfix">
                                <div class="relative clearfix"><a class="logo" href="../../../landing-page/gnsdk-home.htm" alt="Logo"></a>
                                    <div class="navigation-wrapper nocontent">
                                        <ul class="navigation clearfix" data-mc-css-tree-node-has-children="has-children" data-mc-css-sub-menu="sub-menu" data-mc-expand-event="mouseenter" data-mc-top-nav-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                            <li class="placeholder" style="visibility:hidden"><a>placeholder</a>
                                            </li>
                                        </ul>
                                    </div>
                                    <button class="menu-icon" data-toggle="offCanvas"><span></span>
                                    </button>
                                </div>
                            </div>
                            <div class="nav-search row outer-row">
                                <form class="search" action="#">
                                    <div class="search-bar search-bar-container needs-pie">
                                        <input class="search-field needs-pie" type="search" placeholder="Search" />
                                        <div class="search-filter-wrapper">
                                            <div class="search-filter">
                                                <div class="search-filter-content">
                                                    <ul>
                                                        <li>All Files</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="search-submit-wrapper" dir="ltr">
                                            <div class="search-submit" title="Search">
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </nav>
                    </div>
                    <section class="main-section">
                        <div class="row outer-row" data-mc-content-body="True">
                            <p style="font-weight: bold;"><span class="GeneralProductNameFull">GNSDK</span> <span class="GeneralAPI">OO APIs</span></p>
                            <p>Version 3.08.6.5437 : <span class="SystemShortDate">9/14/2017</span></p>
                            <hr width="100%" size="0" align="center" />
                            <div class="content">
                                <div id="contentBody">
                                    <div class="row collapse">
                                        <div class="sideContent">
                                            <div class="clearfix">
                                                <div class="buttons popup-container clearfix topicToolbarProxy _Skins_TopicToolBar mc-component nocontent">
                                                    <div class="button-group-container-left">
                                                        <button class="button needs-pie next-topic-button" title="Navigate next">
                                                            <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="next topic" />
                                                        </button>
                                                        <button class="button needs-pie previous-topic-button" title="Navigate previous">
                                                            <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="previous topic" />
                                                        </button>
                                                        <div class="button-separator">
                                                        </div>
                                                        <button class="button needs-pie remove-highlight-button" title="Remove Highlights">
                                                            <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="remove highlight" />
                                                        </button>
                                                        <div class="button-separator">
                                                        </div>
                                                        <button class="button needs-pie expand-all-button" data-state1-class="expand-all-button" data-state2-class="collapse-all-button" data-state2-title="Collapse all" title="Expand all" data-state1-title="Expand all">
                                                            <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="expand all" />
                                                        </button>
                                                        <div class="button-separator">
                                                        </div>
                                                        <button class="button needs-pie print-button" title="Print">
                                                            <img src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="print" />
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <ul class="nocontent menu _Skins_SideMenu mc-component" data-mc-is-context-sensitive="True" data-mc-linked-toc="Data/Tocs/gnsdk__gnsdk_oo_all.js" data-mc-side-menu="True" data-mc-max-depth="4" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                            </ul>
                                        </div>
                                        <div class="nocontent">
                                            <div class="MCBreadcrumbsBox_0 breadcrumbs" data-mc-breadcrumbs-divider=" &gt; " data-mc-breadcrumbs-count="3" data-mc-toc="True"><span class="MCBreadcrumbsPrefix">You are here: </span>
                                            </div>
                                        </div>
                                        <h1><a name="kanchor91"></a><a name="kanchor92"></a><a name="kanchor93"></a>Using a Local Fingerprint Database</h1>
                                        <p><a name="kanchor94"></a>Gracenote provides a mechanism for you to use a local database of track fingerprints and metadata for identification. The SDK can use this database to attempt a local ID prior to going online. Doing this provides a significant performance improvement if a local match is found. </p>
                                        <p>To create a local database, you need to download and <i>ingest</i> raw fingerprint and metadata from Gracenote, packaged in an entity called a <i>bundle</i><a name="kanchor95"></a>. Currently, you have to work with Gracenote  to create a bundle. In the future,  Gracenote will provide a self-service tool to do this. Having a local database requires that a storage provider, such as SQLite be enabled. You can do this with the <code class="prettyprint">GnStorageSqlite</code> class.</p>
                                        <p>Your application can ingest multiple bundles. If the same track exists in multiple ingested bundles it is added to the local database only once with the most recent/up-to-date track information. The ingestion process can be lengthy; your application may want to do this on a background thread to avoid stalling the main application thread.</p>
                                        <p>To implement local lookup, use the following <code class="prettyprint">GnLookupLocalStream</code> methods :</p>
                                        <ul>
                                            <li value="1"><b><code class="prettyprint">Enable</code></b>
        —Enables the <code class="prettyprint">LookupLocalStream</code> library.</li>
                                            <li value="2"><b><code class="prettyprint">StorageLocation</code></b>
        —Sets the location for your <MadCap:conditionalText data-mc-conditions="Default.mobl-gen-cndt,Default.acr-gen-cndt,Default.desk-gen-cndt"><a name="kanchor96"></a>MusicID Stream </MadCap:conditionalText> fingerprint database . Bundle ingestion creates the database at the location specified. If the path does not exist, ingestion will fail.</li>
                                            <li value="3"><b><code class="prettyprint">StorageRemove</code></b>
        —Removes an item from the local fingerprint database.</li>
                                            <li value="4"><b><code class="prettyprint">StorageClear</code></b>
        —Clears all tracks from the local fingerprint database.</li>
                                        </ul>
                                        <p>And the following <code class="prettyprint">GnLookupLocalStreamIngest</code> methods:</p>
                                        <ul>
                                            <li value="1"><b><code class="prettyprint">Write</code></b>
        —Takes byte data and writes specified number of bytes to local storage.</li>
                                            <li value="2"><b><code class="prettyprint">Flush</code></b>
        —Flushes the memory cache to the file storage and commits the changes. This method ensures that everything written is commited to the file system. Note that this is an optional call as internally data is flushed when it exceed the cache size and when the object goes out of scope.</li>
                                        </ul>
                                        <p>Note that the <code class="prettyprint">GnLookupLocalStreamIngest</code> constructor takes a callback object to handle statuses as the ingest process can take some time. See the API reference documentation for <code class="prettyprint">GnLookupLocalStreamIngest</code> for more information.</p>
                                        <h2><a name="kanchor97"></a>Downloading and Ingesting Bundles</h2>
                                        <p>To manage bundles, your application would typically need to do the following:</p>
                                        <ul>
                                            <li value="1">Manually retrieve a Gracenote-provided bundle</li>
                                            <li value="2">Place bundle in an online location that your application can access</li>
                                            <li value="3">Have your application download and ingest the bundle.</li>
                                        </ul>
                                        <p class="note" data-mc-autonum="&lt;b&gt;&lt;span style=&quot;color: #e31b23;&quot; class=&quot;mcFormatColor&quot;&gt;Note: &lt;/span&gt;&lt;/b&gt;"><span class="autonumber"><span><b><span style="color: #e31b23;" class="mcFormatColor">Note: </span></b></span></span>Bundles should be retrieved from an online source. Gracenote recommends that when your application
is installed or initialized that it download and ingest the latest bundle rather than ship with a bundle as
part of the application binaries.</p>
                                        <p><b>Ingesting bundles code samples:</b>
                                        </p>
                                        <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage" name="kanchor98"><img class="MCDropDown_Image_Icon" src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" height="15" width="16" alt="Closed" data-mc-alt2="Open" />Android Java</a></span>
                                            <div class="MCDropDownBody dropDownBody"><pre class="prettyprint">// Enable storage provider allowing GNSDK to use its persistent stores
GnStorageSqlite.enable();
      
// Enable local <MadCap:conditionalText data-mc-conditions="Default.mobl-gen-cndt,Default.acr-gen-cndt,Default.desk-gen-cndt">MusicID Stream </MadCap:conditionalText> recognition (GNSDK storage provider must be enabled as pre-requisite)
GnLookupLocalStream.enable();
          
// Ingest <MadCap:conditionalText data-mc-conditions="Default.mobl-gen-cndt,Default.acr-gen-cndt,Default.desk-gen-cndt">MusicID Stream </MadCap:conditionalText> local bundle, perform in another thread as it can be lengthy
Thread ingestThread = new Thread( new LocalBundleIngestRunnable(context) );
ingestThread.start();
          
/**
 * Loads a local bundle for <MadCap:conditionalText data-mc-conditions="Default.mobl-gen-cndt,Default.acr-gen-cndt,Default.desk-gen-cndt">MusicID Stream </MadCap:conditionalText><a name="kanchor99"></a> lookups
 */
class LocalBundleIngestRunnable implements Runnable {
   Context context;

   LocalBundleIngestRunnable(Context context) {
      this.context = context;
   }

   public void run() {
     try {
        
       // Our bundle is delivered as a package asset
       // to ingest the bundle access it as a stream and write the bytes to
       // the bundle ingester.
       // Bundles should not be delivered with the package as this, rather they 
       // should be downloaded from your own online service.
        
       InputStream  bundleInputStream = null;
       int      ingestBufferSize  = 1024;
       byte[]     ingestBuffer    = new byte[ingestBufferSize];
       int      bytesRead     = 0;
        
       GnLookupLocalStreamIngest ingester = new GnLookupLocalStreamIngest(new BundleIngestEvents());
        
       try {
          
         bundleInputStream = context.getAssets().open("1557.b");
          
         do {
            
           bytesRead = bundleInputStream.read(ingestBuffer, 0, ingestBufferSize);
           if ( bytesRead == -1 )
            bytesRead = 0;
          
           ingester.write( ingestBuffer, bytesRead );
            
        } while( bytesRead != 0 );
          
    } catch (IOException e) {
      e.printStackTrace();
    }
        
    ingester.flush();
        
  } catch (GnException e) {
     Log.e( appString, e.errorCode() + ", " + e.errorDescription() + ", " + e.errorModule() );
  }    
  }
}</pre>
                                            </div>
                                        </div>
                                        <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" height="15" width="16" alt="Closed" data-mc-alt2="Open" />Objective-C</a></span>
                                            <div class="MCDropDownBody dropDownBody"><pre class="prettyprint"><a name="kanchor100"></a>- (NSError *) setupLocalLookup
{
  NSError *  error = nil;

  /*  Initialize the local lookup so we can do local lookup queries.  */
  self.gnLookupLocalStream = [GnLookupLocalStream enable: &amp;error];
  if (! error)
  {
    NSString *  docDir = [GnAppDelegate applicationDocumentsDirectory];
    [self.gnLookupLocalStream storageLocation: docDir
                      error: &amp;error];
    if (! error)
    {
        // Look for the 10,000 track bundle and if not found try the little one.
        NSString*  bundlePath = [[NSBundle mainBundle] pathForResource: @"1557.b" ofType: nil];
      
        if (bundlePath)
        {
          [self.gnLookupLocalStream storageClear: &amp;error];
          
          if (! error)
          {
            __block GnLookupLocalStreamIngest *lookupLocalStreamIngest = [[GnLookupLocalStreamIngest alloc] initWithGnLookupLocalStreamIngestEventsDelegate:self];
            
            // Load Bundle in a separate thread to keep the UI responsive. This is required for Large Bundles that can take few minutes to be ingested.
            
            dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_BACKGROUND, 0), ^{
              
              NSError *error = nil;
              NSInteger bytesRead = 0;
              double totalBytesRead = 0;
              uint8_t buffer[1024];
              NSInputStream *fileInputStream = [NSInputStream inputStreamWithFileAtPath:bundlePath];
              
              [fileInputStream open];
              
              do {
                bytesRead =  [fileInputStream read:buffer maxLength:1024];
                [lookupLocalStreamIngest write:buffer dataSize:sizeof(buffer) error:&amp;error];
                
                if(error)
                {
                  NSLog(@"Error during lookupLocalStreamIngest write: %@", [error localizedDescription]);
                }
                
                totalBytesRead+=bytesRead;
                
              }while (bytesRead&gt;0);
              
              [lookupLocalStreamIngest flush:&amp;error];
              [fileInputStream close];
              
            });
          }
        }
    }
  }

  return error;
}</pre>
                                            </div>
                                        </div>
                                        <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage" name="kanchor101"><img class="MCDropDown_Image_Icon" src="../../../../Skins/Default/Stylesheets/Images/transparent.gif" height="15" width="16" alt="Closed" data-mc-alt2="Open" />Windows Phone C#</a></span>
                                            <div class="MCDropDownBody dropDownBody"><pre class="prettyprint">// Ingest local fingerprint bundle
GnLookupLocalStream lookupLocalStream = GnLookupLocalStream.Enable;

lookupLocalStream.StorageLocation(Windows.Storage.ApplicationData.Current.LocalFolder.Path);

GnLookupLocalStreamIngest lookupLocalStreamIngest = new GnLookupLocalStreamIngest(this);

// Bundle assset path including asset name. The code assumes that the bundle 
// to be ingested  was added to the project as a content file.            
string bundlePath = "1557.b";

Stream bundleFileStream = Application.GetResourceStream(new Uri(bundlePath, UriKind.Relative)).Stream;

byte[] buffer = new byte[1024 + 10];
int count = 1024;
int read = 0;
while (0 != (read = bundleFileStream.Read(buffer, 0, count)))
{
   lookupLocalStreamIngest.Write(buffer, (uint)read);
}

lookupLocalStreamIngest.Flush();
</pre>
                                            </div>
                                        </div>
                                        <h2><a name="kanchor103"></a><a name="kanchor104"></a>Designating a Storage Provider</h2>
                                        <p>A <i>storage provider</i> module implements GNSDK local storage. By default, no storage provider is enabled.To use SQLite, your application should instantiate a <code class="prettyprint">GnStorageSqlite</code> object and call its <code class="prettyprint">enable</code> method.</p>
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                        <br />
                                    </div>
                                </div>
                            </div>
                            <hr width="100%" size="0" align="center" />
                        </div>
                    </section><a data-close="true"></a>
                </div>
            </div>
            <script>/* <![CDATA[ */$(document).foundation();/* ]]> */</script>
        </div>
    </body>
</html>